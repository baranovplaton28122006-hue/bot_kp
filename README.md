# Бот-анкета для КП / Brief-Builder (Telegram)

Этот проект — Telegram-бот, который проводит клиента через многошаговую анкету (бриф) и в конце формирует HTML/PDF‑версию коммерческого предложения (КП). Код подготовлен к презентации: добавлены комментарии по модулям и функциям, структура упорядочена, файл README описывает, как всё устроено и как запускать.

> ⚠️ **Важно про токен**: в `kp_bot/config.py` есть дефолтный токен. Для продакшн‑запуска **обязательно** задайте переменную окружения `TELEGRAM_TOKEN` и/или замените токен в конфиге. Не коммитите рабочие токены в репозиторий.

---

## Стек и зависимости

- **Python 3.10+** (рекомендуется)
- **pyTelegramBotAPI (telebot)** — Telegram Bot API
- **Jinja2** — шаблонизация HTML для КП
- **pdfkit** — конвертация HTML → PDF (требует установленный бинарник **wkhtmltopdf**)
- Стандартная библиотека Python: `logging`, `os`, `pathlib`, `re`, `datetime`, и т.п.

Установка зависимостей (пример):

```bash
python -m venv .venv
# Windows
.venv\Scripts\pip install --upgrade pip
.venv\Scripts\pip install pyTelegramBotAPI jinja2 pdfkit
# Linux/macOS
source .venv/bin/activate
pip install --upgrade pip
pip install pyTelegramBotAPI jinja2 pdfkit
```

Установите **wkhtmltopdf**:
- Windows: скачайте инсталлятор с сайта проекта и убедитесь, что путь совпадает с `path_wkhtmltopdf` в `kp_bot/config.py`.
- Linux/macOS: установите пакет из менеджера пакетов и/или пропишите путь для `pdfkit.configuration()`.

---

## Переменные окружения

- `TELEGRAM_TOKEN` — токен бота. Если не задан, берётся значение из `kp_bot/config.py` (не рекомендуется для продакшна).
- (опционально) `WKHTMLTOPDF_PATH` — можно добавить поддержку чтения пути к бинарнику из переменной окружения и прокинуть в `pdfkit.configuration(...)`.

Пример (Windows PowerShell):

```powershell
$env:TELEGRAM_TOKEN = "123456:ABC..."
python .\main_modular.py
```

Пример (Linux/macOS):

```bash
export TELEGRAM_TOKEN="123456:ABC..."
python main_modular.py
```

---

## Структура проекта

```
  README.md
  main_modular.py
  generated_kp/
  kp_bot/
    __init__.py
    config.py
    contacts.py
    flows.py
    handlers.py
    keyboards.py
    labels.py
    logging_setup.py
    main.py
    models.py
    multiselect.py
    options.py
    pdfgen.py
    progress.py
    render.py
    runtime.py
    states.py
    ui.py
    utils.py
    handlers/
      callbacks.py
      send_step.py
    services/
      multiselect.py
      pdf.py
      render.py
```

Ключевые директории/файлы:
- `main_modular.py` — точка входа. Готовит пути импорта и запускает бота.
- `kp_bot/` — пакет с бизнес‑логикой:
  - `handlers.py` — обработчики сообщений и callback‑кнопок, навигация по шагам.
  - `render.py` — формирование текстов/клавиатур по шагам, безопасная отправка/редактирование.
  - `flows.py` — конфиг сценариев (порядок шагов, ветки по решению) и хранилище состояний `USER`.
  - `keyboards.py` — генераторы inline‑клавиатур: да/нет, мультивыбор, пагинация, «Назад/Домой».
  - `options.py` — справочники опций и функции «очеловечивания» данных.
  - `states.py` — определения `telebot`‑состояний (FSM) для текстового ввода.
  - `pdfgen.py` — генерация HTML (и PDF) для КП на основе Jinja2.
  - `logging_setup.py` — настройка логов.
  - `handlers/` — детализированные обработчики, если логика вынесена из общего `handlers.py`.
  - `services/` — сервисные модули (рендеринг, мультивыбор, PDF).

Все `.py` в папке «комментированной» версии снабжены авто‑комментариями `# [auto]: ...` и модульными docstring‑ами. Логика кода **не менялась**.

---

## Быстрый старт

1. Создайте и активируйте виртуальное окружение (см. выше).
2. Установите зависимости (`pyTelegramBotAPI`, `jinja2`, `pdfkit`) и **wkhtmltopdf**.
3. Установите `TELEGRAM_TOKEN`.
4. Запустите бота:
   - `python main_modular.py` (корень проекта), или
   - `python kp_bot/main.py` (внутри пакета).
5. Откройте диалог с вашим ботом в Telegram и нажмите «Старт».

Логи выводятся в консоль. При необходимости подключите файл‑логгер в `logging_setup.py`.

---

## Как это работает (в общих чертах)

1. **Пользователь** нажимает «Старт» → бот создаёт или находит запись в `USER[ch]` и выводит первый шаг.
2. **Навигация** идёт по массиву шагов `flow` (см. `flows.py`). Базовый порядок включает:
   `name → org_name → has_site → has_site_comment → biz_goal → user_action → product → solution`.
3. На шаге **solution** выбирается тип решения → ветка сценария:
   - **A**: лендинг/корпоративный сайт → блоки (A1), функционал (A2).
   - **B**: интернет‑магазин → каталог (B1), фильтры/вариации/оплата/доставка и т.п.
   - **C**: чат‑бот → каналы, сценарии, формы и т.п.
   - **D**: другое/другое решение.
   После ветвления добавляются общие шаги: `design`, `content`, `timeline`, `contacts`, `confirm`.
4. Каждый шаг рендерится через `render.py`: текст + inline‑кнопки (`keyboards.py`). Для мультивыбора используется контекст `multiselect_ctx` и пагинация.
5. В конце можно сгенерировать **КП**: модуль `pdfgen.py` создаёт HTML‑файл (и/или PDF) в каталоге `generated_kp`. Путь к `wkhtmltopdf` настраивается в `config.py`.

---

## Генерация КП (HTML/PDF)

- Шаблон HTML описан прямо в `kp_bot/pdfgen.py` (Jinja2).
- По клику «Сформировать КП» сохраняется файл в папку `generated_kp` (создаётся автоматически).
- Для PDF используется `pdfkit` → нужен установленный **wkhtmltopdf**. Если PDF недоступен, сохраняется HTML — его можно открыть в браузере или сконвертировать позже.

---

## Добавленные комментарии

В каждой `.py` вставлен модульный docstring с кратким описанием и пометкой, что файл аннотирован автоматически. Перед объявлениями `def`/`class` добавлены лёгкие комментарии формата:

```python
# [auto]: обработчик on_cb() 
def on_cb(...):
    ...
```

Это **не влияет** на исполнение кода и служит ориентиром для ревью/презентации. Логика, сигнатуры и импорты **не менялись**.

---

## Советы по разработке

- **Линтеры/форматтеры**: стоит подключить `ruff`/`flake8` и `black`.
- **Логи**: при отладке callback‑данных логируйте `c.data` и текущий шаг `cur_step(ch)`, чтобы быстрее ловить ошибки навигации.
- **Стейт‑машина**: текстовый ввод (например, «Свой вариант») обрабатывается через `telebot`‑состояния (`states.py`).
- **Расширение шагов**: добавляйте новые ключи в `flows.py` и соответствующие рендеры/клавиатуры в `render.py` и `keyboards.py`.

---

## Частые проблемы

- **IndentationError/SyntaxError** — проверьте смешение табов/пробелов; используйте 4 пробела.
- **NameError: framed** — убедитесь, что импортируете `framed` из `utils.py` там, где он вызывается.
- **pdfkit/wkhtmltopdf not found** — установите бинарник и укажите путь в `config.py`.

---

## Лицензия и авторство

Исходники принадлежат автору проекта. Автокомментарии и текущий README сгенерированы автоматически для удобства презентации и ревью.
